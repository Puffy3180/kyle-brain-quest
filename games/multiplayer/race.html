<!DOCTYPE html>
<html>
<head>
    <title>Speed Run (2P)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #a29bfe; color: #fff; font-family: 'Space Grotesk', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .split { display: flex; width: 100%; height: 100%; }
        .lane { flex: 1; border-right: 4px solid #fff; position: relative; overflow: hidden; }
        .p1-lane { background: #6c5ce7; }
        .p2-lane { background: #e17055; }
        .player { position: absolute; width: 40px; height: 40px; bottom: 20px; left: 50%; transform: translateX(-50%); background: #fff; transition: left 0.1s; }
        .obstacle { position: absolute; width: 100px; height: 20px; background: #2d3436; left: 50%; transform: translateX(-50%); }
        .score { position: absolute; top: 20px; width: 100%; text-align: center; font-size: 3rem; }
        .msg { position: absolute; top: 50%; width: 100%; text-align: center; font-size: 2rem; display: none; }
        .back-btn { position: absolute; bottom: 20px; left: 20px; color: #fff; text-decoration: none; z-index: 10; }
    </style>
</head>
<body>
    <a href="../../index.html" class="back-btn">Quit</a>

    <div class="split">
        <div class="lane p1-lane" id="lane1">
            <div class="score" id="score1">0</div>
            <div class="msg" id="msg1">CRASHED!</div>
            <div class="player" id="p1"></div>
        </div>
        <div class="lane p2-lane" id="lane2">
            <div class="score" id="score2">0</div>
            <div class="msg" id="msg2">CRASHED!</div>
            <div class="player" id="p2"></div>
        </div>
    </div>

    <script>
        const p1El = document.getElementById('p1');
        const p2El = document.getElementById('p2');
        const lane1 = document.getElementById('lane1');
        const lane2 = document.getElementById('lane2');
        
        let p1 = { x: 50, alive: true, score: 0 };
        let p2 = { x: 50, alive: true, score: 0 };
        
        let obstacles1 = [];
        let obstacles2 = [];
        let speed = 5;
        let gameRunning = true;

        const keys = {};
        window.addEventListener('keydown', e => {
            keys[e.code] = true;
            if (!gameRunning && e.code === 'Space') location.reload();
        });
        window.addEventListener('keyup', e => keys[e.code] = false);

        function spawnObstacle(arr, el) {
            const obs = document.createElement('div');
            obs.className = 'obstacle';
            const pos = Math.random() < 0.33 ? 20 : (Math.random() < 0.5 ? 50 : 80);
            obs.style.left = pos + '%';
            obs.style.top = '-50px';
            el.appendChild(obs);
            arr.push({ el, y: -50, x: pos }); // x is percent
        }

        function update() {
            if (!gameRunning) return;

            // Movement
            if(keys['KeyA']) p1.x = 20;
            if(keys['KeyS']) p1.x = 50;
            if(keys['KeyD']) p1.x = 80;

            if(keys['ArrowLeft']) p2.x = 20;
            if(keys['ArrowDown']) p2.x = 50;
            if(keys['ArrowRight']) p2.x = 80;

            p1El.style.left = p1.x + '%';
            p2El.style.left = p2.x + '%';

            // Spawning
            if (Math.random() < 0.05) spawnObstacle(obstacles1, lane1);
            if (Math.random() < 0.05) spawnObstacle(obstacles2, lane2);

            // Move Obstacles
            moveObstacles(obstacles1, p1, 'score1', 'msg1');
            moveObstacles(obstacles2, p2, 'score2', 'msg2');

            if (!p1.alive && !p2.alive) gameRunning = false;

            requestAnimationFrame(update);
        }

        function moveObstacles(arr, player, scoreId, msgId) {
            if (!player.alive) return;

            for (let i = arr.length - 1; i >= 0; i--) {
                let o = arr[i];
                o.y += speed;
                o.el.lastChild.style.top = o.y + 'px'; // Hacky access to DOM element

                // Collision
                // Player Y is bottom 20px (height 40px) -> window height - 60px to -20px
                const h = window.innerHeight;
                if (o.y > h - 100 && o.y < h - 20) {
                    if (o.x === player.x) {
                        player.alive = false;
                        document.getElementById(msgId).style.display = 'block';
                    }
                }

                if (o.y > h) {
                    o.el.removeChild(o.el.lastChild);
                    arr.splice(i, 1);
                    player.score++;
                    document.getElementById(scoreId).innerText = player.score;
                }
            }
        }
        
        // Rewrite spawn to actually append to lane correctly and track DOM
        // The previous function was slightly broken because I didn't store the div ref properly in the array
        
        obstacles1 = [];
        obstacles2 = [];

        function spawnReal(arr, lane) {
            const div = document.createElement('div');
            div.className = 'obstacle';
            const pos = Math.random() < 0.33 ? 20 : (Math.random() < 0.5 ? 50 : 80);
            div.style.left = pos + '%';
            div.style.top = '-50px';
            lane.appendChild(div);
            arr.push({ div: div, y: -50, x: pos });
        }

        function updateReal() {
            if (!gameRunning) return;

            // Move
            if(keys['KeyA']) p1.x = 20;
            if(keys['KeyS']) p1.x = 50;
            if(keys['KeyD']) p1.x = 80;

            if(keys['ArrowLeft']) p2.x = 20;
            if(keys['ArrowDown']) p2.x = 50;
            if(keys['ArrowRight']) p2.x = 80;

            p1El.style.left = p1.x + '%';
            p2El.style.left = p2.x + '%';

            speed += 0.005;

            // Spawn
            if (p1.alive && Math.random() < 0.02) spawnReal(obstacles1, lane1);
            if (p2.alive && Math.random() < 0.02) spawnReal(obstacles2, lane2);

            // Update Obs
            [ {arr: obstacles1, p: p1, msg: 'msg1', score: 'score1'}, 
              {arr: obstacles2, p: p2, msg: 'msg2', score: 'score2'} ].forEach(obj => {
                if (!obj.p.alive) return;
                
                for (let i = obj.arr.length - 1; i >= 0; i--) {
                    let o = obj.arr[i];
                    o.y += speed;
                    o.div.style.top = o.y + 'px';

                    // Collision (Player is at bottom 20px, height 40px)
                    // Obstacle height 20px
                    const pTop = window.innerHeight - 60;
                    const pBottom = window.innerHeight - 20;
                    
                    if (o.y + 20 > pTop && o.y < pBottom) {
                        if (o.x === obj.p.x) {
                            obj.p.alive = false;
                            document.getElementById(obj.msg).style.display = 'block';
                        }
                    }

                    if (o.y > window.innerHeight) {
                        o.div.remove();
                        obj.arr.splice(i, 1);
                        obj.p.score++;
                        document.getElementById(obj.score).innerText = obj.p.score;
                    }
                }
            });

            if (!p1.alive && !p2.alive) {
               // End
            }

            requestAnimationFrame(updateReal);
        }

        updateReal();

    </script>
</body>
</html>
